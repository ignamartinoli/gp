<div class="div_section">
    <h3 class="siac_title">Editar Componente</h3>
    <hr>
    <h3>Parámetros Generales</h3>

    <%= form_for @componente, url: update_componente_path(@componente), html: { onsubmit: 'return validarNuevoComponente(event)' }, id: 'formComponente', method: :patch do |f| %>
    <div class="field-container">
        <div class="long-field">
        <%= f.label :nombre, 'Nombre de Componente:' %>
        <span class="tooltip">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16">
            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
            </svg>
            <span class="tooltiptext">Nombre representativo para identificar la componente.</span>
        </span>
        <%= f.text_field :nombre, id: 'inputNombreComponente' %>
        </div>
    </div>

    <div class="error-container">
      <div class="errorNombre"></div>
    </div>

    <div class="field-container">
        <div class="long-field">
        <%= f.label :descripcion, 'Descripción de Componente:' %>
        <span class="tooltip">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16">
            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
          </svg>
          <span class="tooltiptext">Descripción breve sobre la función de la componente.</span>
        </span>
        <%= f.text_field :descripcion, id: 'inputDescripcionComponente' %>
        </div>
    </div>

    <div class="error-container">
      <div class="errorDescripcion"></div>
    </div>

    <div class="field-container">
        <div class="long-field">
        <%= f.label :dimension_id, 'Dimensión:' %>
        <span class="tooltip">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16">
            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
            </svg>
            <span class="tooltiptext">Dimensión relacionada a la componente.</span>
        </span>
        <%= f.select :dimension_id, options_from_collection_for_select(@dimensiones, :id, :dimension, @componente.dimension_id), include_blank: 'Selecciona una opción' %>
        </div>
    </div>

    <div class="error-container">
      <div class="errorDimension"></div>
    </div>

    <hr>

    <!-- Campos anidados (similar al formulario new) -->
    <div id="campos">
        <% @campos_activos.each_with_index do |campo, index| %>
        <%= f.fields_for :campos, campo do |campo_form| %>
            <div class="nested-fields" data-index="<%= index %>">
            <%= campo_form.hidden_field :id %>
            <h3>Campo <span class="campo-index"><%= index + 1 %></span></h3>

            <div class="field">
                <%= campo_form.label :pregunta, "Pregunta:" %>
                <span class="tooltip">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16">
                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
                    </svg>
                    <span class="tooltiptext">Pregunta tal cual figurara en el formulario.</span>
                </span>
                <%= campo_form.text_field :pregunta, class: "inputPregunta" %>
            </div>

            <div class="long-field">
                <%= campo_form.label :obligatorio, "¿Es obligatorio completar este campo?" %>
                <div class="checkboxContainer">
                <%= campo_form.check_box :obligatorio, { class: "checkbox" }, "1", "0" %>
                </div>
            </div>

            <div class="long-field">
                <%= campo_form.label :tiene_pregunta_orientadora, "¿Este campo posee pregunta orientadora?" %>
                <div class="checkboxContainer">
                <%= campo_form.check_box :tiene_pregunta_orientadora, { class: "checkbox checkbox_pregunta_orientadora" }, "1", "0" %>
                </div>  
            </div>


            <div class="field pregunta_orientadora_container">
                <%= campo_form.label :descripcion , "Pregunta Orientadora:" %>
                <span class="tooltip">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16">
                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
                </svg>
                <span class="tooltiptext">Pregunta para guiar la respuesta.</span>
                </span>
                <%= campo_form.text_area :descripcion , class: "inputPreguntaOrientadora" %>
            </div>

            <div class="field">
                <%= campo_form.label :tipo_campo_id, "Tipo de Campo" %>
                <span class="tooltip">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16">
                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
                    </svg>
                    <span class="tooltiptext">Tipo de campo habilitado para la respuesta a la pregunta</span>
                </span>
                <%= campo_form.select :tipo_campo_id, options_for_select([["Selecciona una opción", ""]] + @tipos_campo.map { |t| [t.nombre, t.id] }, campo_form.object.tipo_campo_id) %>
            </div>

            <div class="error-container">
              <div class="errorCampo"></div>
            </div>

            <%= link_to "Eliminar Campo", "#", class: "remove_fields siac_button" %>
            <br><br>
            <hr>
            </div>
        <% end %>
        <% end %>
    </div>

    <%= link_to "+ Agregar un nuevo campo a la componente", "#", id: "add_field", class: "add_field siac_button" %>

    <div class="submit-container">
    <input type="submit" id="inputSubmit" class="submit siac_button" value="Actualizar Componente">
    </div>
    <% end %>
</div>

<%= link_to 'Volver a componentes', componentes_path %>

<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'siac.css', plugin: :utn_siac %>
  <%= javascript_include_tag 'validaciones_componentes', plugin: :utn_siac %>
  <%= csrf_meta_tags %>
<% end %>

<script>
document.addEventListener("DOMContentLoaded", function() {

// Obtener todos los checkboxes de pregunta orientadora
const checkboxesPreguntaOrientadora = document.querySelectorAll(".checkbox_pregunta_orientadora");

// Función para actualizar la visibilidad del contenedor de pregunta orientadora
function actualizarVisibilidadPreguntaOrientadora(checkbox) {
  // Obtener el contenedor relacionado con este checkbox
  const contenedorPreguntaOrientadora = checkbox.closest(".nested-fields").querySelector(".pregunta_orientadora_container");

  // Mostrar u ocultar el contenedor según si el checkbox está marcado o no
  if (checkbox.checked) {
    contenedorPreguntaOrientadora.style.display = "block"; // Mostrar
  } else {
    contenedorPreguntaOrientadora.style.display = "none"; // Ocultar
  }
}

// Al cargar la página, actualizar la visibilidad para cada checkbox
checkboxesPreguntaOrientadora.forEach(function(checkbox) {
  actualizarVisibilidadPreguntaOrientadora(checkbox);
});

  const camposContainer = document.getElementById("campos");
  const botonAgregar = document.getElementById("add_field");

  // Función para actualizar los números de los campos
  function actualizarNumerosCampos() {
    document.querySelectorAll(".nested-fields").forEach((field, index) => {
      field.dataset.index = index; // Puedes usar index+1 para mostrar numeración amigable
      const campoIndexElement = field.querySelector(".campo-index");
      if (campoIndexElement) {
        campoIndexElement.textContent = index + 1;
      }

      // Mostrar/Ocultar botón de eliminar
      const botonEliminar = field.querySelector(".remove_fields");
      if (botonEliminar) {
        botonEliminar.style.display = (index === 0) ? "none" : "inline";
      }

      // Vincular eventos a nuevos checkboxes
      const checkboxPreguntaOrientadora = field.querySelector(".checkbox_pregunta_orientadora");
      if (checkboxPreguntaOrientadora) {
        checkboxPreguntaOrientadora.addEventListener("change", togglePreguntaOrientadora);
      }
    });
  }
  // Función para controlar el estado del checkbox
  function togglePreguntaOrientadora() {
    // Aquí seleccionamos el contenedor del campo 'pregunta_orientadora_container' 
    const container = $(this).closest(".nested-fields").find(".pregunta_orientadora_container");
    if ($(this).prop('checked')) {
      container.show();  // Mostrar el div si el checkbox está marcado
    } else {
      container.hide();  // Ocultar el div si el checkbox está desmarcado
    }
  }

  // Evento para agregar nuevos campos
  botonAgregar.addEventListener("click", function(e) {
    e.preventDefault();

    // Obtener todos los campos actuales
    const allFields = document.querySelectorAll(".nested-fields");
    if (allFields.length === 0) {
      console.log("No hay campos para clonar.");
      return;
    }

    // Clonar el último campo
    const lastField = allFields[allFields.length - 1];
    const newField = lastField.cloneNode(true);

    // Nuevo índice será el tamaño actual de la colección
    const newIndex = allFields.length;
    newField.dataset.index = newIndex;

    // Actualizar el texto del número del campo
    const campoIndexElement = newField.querySelector(".campo-index");
    if (campoIndexElement) {
      campoIndexElement.textContent = newIndex + 1;
    }

    // Actualizar atributos name, id y limpiar valores en el nuevo campo
    newField.querySelectorAll("input, textarea, select").forEach(input => {
      if (input.name) {
        // Reemplaza el número entre corchetes por el nuevo índice.
        input.name = input.name.replace(/\[\d+\]/, `[${newIndex}]`);
      }
      if (input.id) {
        // Si el id termina en _<número>, actualízalo también.
        input.id = input.id.replace(/_\d+$/, `_${newIndex}`);
      }
      // Limpiar el valor del input
      input.value = "";
      // Si es checkbox, desmarcarlo
      if (input.type === "checkbox") {
        input.checked = false;
      }
    });

    // Limpiar los errores asociados con el nuevo campo
    const errorContenedor = newField.querySelector('.errorCampo');
    if (errorContenedor) {
      errorContenedor.innerHTML = '';
      errorContenedor.classList.remove('error');
    }

    // Agregar el nuevo campo al contenedor
    camposContainer.appendChild(newField);

    // Actualizar la numeración de todos los campos
    actualizarNumerosCampos();

    // Llamar a la función para asegurarnos que la visibilidad del textarea se ajuste al estado del checkbox en el nuevo campo
    togglePreguntaOrientadora.call(newField.querySelector(".checkbox_pregunta_orientadora"));
  });

  // Evento para eliminar campos
  camposContainer.addEventListener("click", function(e) {
    if (e.target.classList.contains("remove_fields")) {
      e.preventDefault();
      const allFields = document.querySelectorAll(".nested-fields");
      // Evitar eliminar el primer campo
      if (allFields.length > 1) {
        e.target.closest(".nested-fields").remove();
        actualizarNumerosCampos();
      }
    }
  });

  // Llamar a la función al inicio
  actualizarNumerosCampos();
  togglePreguntaOrientadora();
});

</script>