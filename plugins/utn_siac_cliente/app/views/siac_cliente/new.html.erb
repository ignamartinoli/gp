<%# app/views/convocatoria/preview.html.erb %>

<%
  componentes_de_convocatoria = @convocatoria.componentes.includes(:campos, :dimension)
  componentes_por_dimension = componentes_de_convocatoria.group_by(&:dimension_id)
%>

<div class="convocatoria-layout">
  <!-- COLUMNA IZQUIERDA: PANEL DE DIMENSIONES -->
  <div class="dimensiones-column">
    <button
      id="dimensiones-collapse-toggle"
      class="dimensiones-collapse-toggle"
      type="button"
      aria-label="Ocultar/mostrar panel de dimensiones"
      aria-expanded="true"
    >
      ¬´
    </button>

    <div id="dimensiones-panel" class="div_section dimensiones-panel">
      <div class="dimensiones-header">
        <span class="dimensiones-title">Dimensiones</span>
      </div>

      <% if @dimensiones.present? %>
        <nav class="dimensiones-nav">
          <ul class="dimensiones-list">
            <% @dimensiones.each_with_index do |dimension, i| %>
              <li class="dimensiones-item">
                <a
                  href="#dimension-<%= dimension.id %>"
                  class="dimensiones-link <%= 'is-active' if i == 0 %>"
                  data-dimension-link="true"
                  data-target="dimension-<%= dimension.id %>"
                >
                  <span class="dimensiones-index"><%= i + 1 %>.</span>
                  <span class="dimensiones-name"><%= dimension.dimension %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </nav>
      <% else %>
        <p class="dimensiones-empty">No hay dimensiones asociadas.</p>
      <% end %>
    </div>
  </div>

  <!-- COLUMNA DERECHA -->
  <div class="convocatoria-column">
    <div class="div_section" style="margin-top: 0;">
      <hr>
      <h1><%= @convocatoria.nombre %></h1>

      <% if @dimensiones.present? %>
        <% @dimensiones.each_with_index do |dimension, idx| %>
          <% componentes = (componentes_por_dimension[dimension.id] || []) %>

          <section
            class="dimension-section <%= 'is-visible' if idx == 0 %>"
            id="dimension-<%= dimension.id %>"
          >
            <% if componentes.any? %>

              <div class="componentes-tabs" role="tablist" aria-label="Componentes">
                <% componentes.each_with_index do |componente, c_idx| %>
                  <button
                    type="button"
                    class="componente-tab <%= 'is-active' if c_idx == 0 %>"
                    data-componente-tab="true"
                    data-target="componente-<%= componente.id %>"
                  >
                    <%= componente.nombre %>
                  </button>
                <% end %>
              </div>

              <div class="subtabs" role="tablist" aria-label="Tipo de campos">
                <button type="button" class="subtab is-active" data-campos-tab="true" data-mode="info">
                  INFORMACI√ìN
                </button>
                <button type="button" class="subtab" data-campos-tab="true" data-mode="auto">
                  AUTOEVALUACI√ìN
                </button>
              </div>

              <div class="componentes-content">
                <% componentes.each_with_index do |componente, c_idx| %>
                  <div
                    class="componente-section <%= 'is-visible' if c_idx == 0 %>"
                    id="componente-<%= componente.id %>"
                  >
                    <% campos_info = componente.campos.select { |c| c.autoevaluacion.to_i == 0 } %>
                    <% campos_auto = componente.campos.select { |c| c.autoevaluacion.to_i == 1 } %>

                    <div class="campos-group is-visible" data-campos-group="info">
                      <% if campos_info.any? %>
                        <div class="campos-list">
                          <% campos_info.each_with_index do |campo, index| %>
                            <%= generar_campo(campo, index + 1) %>
                          <% end %>
                        </div>
                      <% else %>
                        <div class="campos-empty"><em>(Sin campos de informaci√≥n)</em></div>
                      <% end %>
                    </div>

                    <div class="campos-group" data-campos-group="auto">
                      <% if campos_auto.any? %>
                        <div class="campos-list">
                          <% campos_auto.each_with_index do |campo, index| %>
                            <%= generar_campo(campo, index + 1) %>
                          <% end %>
                        </div>
                      <% else %>
                        <div class="campos-empty"><em>(Sin campos de autoevaluaci√≥n)</em></div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>

            <% else %>
              <p><em>No hay componentes asociados a esta dimensi√≥n para esta convocatoria.</em></p>
            <% end %>
          </section>
        <% end %>
      <% else %>
        <p>No hay dimensiones asociadas.</p>
      <% end %>

      <div class="submit-container">
        <%= link_to "Volver a las convocatorias", convocatorias_path, class: "siac_button" %>
      </div>
    </div>
  </div>
</div>

<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'siac.css', plugin: :utn_siac %>

  <%= javascript_include_tag 'jquery-ui/widgets/dialog' %>
  <%= stylesheet_link_tag 'jquery-ui/themes/base/dialog' %>

  <%= javascript_include_tag 'componentes', plugin: :utn_siac %>
  <%= javascript_include_tag 'stepper_plantel_docente', plugin: :utn_siac %>

  <style>
      /* ===== Layout general ===== */

      /* Don‚Äôt touch the layout‚Äôs top offset. Only remove inner padding if you want. */
      #header h1 {
          margin-top: 18px;
          margin-bottom: 22px;
      }
      #header {
          padding-bottom: 0;
          margin-bottom: 0;
          min-height: 73px;
      }
      #main {
          background: #fff;
      }
      #content {
          padding: 0;
      }
      .convocatoria-layout{
          display:flex;
          align-items:stretch;
          gap:1.5rem;
          margin-top: 0;
      }

      .convocatoria-column{
          flex:1 1 auto;
          min-width:0;
      }

      /* ===== Sidebar de dimensiones (igual que la primera) ===== */

      .dimensiones-column{
          position:relative;
          flex:0 0 260px;
          max-width:260px;
          background:#1f2840;
          color:#e5ebff;
          display:flex;
          min-height:100vh;
          overflow:hidden; /* üî¥ evita ‚Äústick out‚Äù visual */
      }

      .dimensiones-panel.div_section{
          background:transparent;
          border:none;
          box-shadow:none;
          margin-top: 0;
      }

      .dimensiones-panel{
          padding:1.4rem 1.2rem 2.6rem;
          width:100%;
      }

      .dimensiones-header{
          display:flex;
          align-items:center;
          justify-content:space-between;
          font-size:1.05rem;
          font-weight:600;
          margin-bottom:0.85rem;
      }

      .dimensiones-title{ letter-spacing:0.02em; }

      .dimensiones-nav{ margin-top:0.5rem; }

      .dimensiones-list{
          list-style:none;
          margin:0;
          padding:0;
      }

      .dimensiones-item + .dimensiones-item{ margin-top:0.3rem; }

      .dimensiones-link,
      .dimensiones-link .dimensiones-name,
      .dimensiones-link .dimensiones-index{
          color:#ffffff !important;
          font-weight:600;
          font-size:1rem;
          text-decoration:none;
          display:flex;
          align-items:baseline;
          gap:0.35rem;
          padding:0.45rem 0.55rem;
          border-radius:8px;
      }

      .dimensiones-link:hover{
          background:rgba(255,255,255,0.10);
          color:#ffffff !important;
      }

      .dimensiones-link.is-active{
          background:#0d7fe6;
          color:#ffffff !important;
      }

      .dimensiones-name{ flex:1; line-height:1.3; }

      .dimensiones-empty{ font-size:0.9rem; color:#c3cbe6; }

      /* ===== Bot√≥n colapso ===== */

      .dimensiones-collapse-toggle{
          position:absolute;
          right:0;
          width:40px;
          height:40px;
          border:none;
          background:#1f2840;
          color:#ffffff;
          cursor:pointer;
          display:flex;
          align-items:center;
          justify-content:center;
          border-radius:6px 0 0 0;
          box-shadow:0 0 6px rgba(0,0,0,0.4);
          font-size:22px;
          padding:0;
          z-index:2;
      }

      .dimensiones-collapse-toggle:hover{ background:#27335a; }

      .dimensiones-column.is-collapsed{
          max-width:40px;
          flex-basis:40px;
      }

      .dimensiones-panel.is-hidden{
          opacity:0;
          pointer-events:none;
      }

      /* ===== Contenido derecha ===== */

      .dimension-section{ scroll-margin-top:16px; }

      /* Mostrar s√≥lo la dimensi√≥n seleccionada */
      .dimension-section{ display:none; }
      .dimension-section.is-visible{ display:block; }

      /* Tabs componentes (versi√≥n ‚Äúque no rompe layout‚Äù) */
      .componentes-tabs{
          display:flex;
          flex-wrap:nowrap;
          gap:0.6rem;
          padding:0.35rem 0.2rem 0.6rem;
          margin:0.35rem 0;
          overflow:hidden;
      }

      .componente-tab{
          flex:1 1 0;
          min-width:0;
          max-width:100%;
          border:none;
          cursor:pointer;
          padding:0.55rem 0.95rem;
          border-radius:8px;
          background:#6f7f90;
          color:#fff;
          font-weight:600;
          white-space:nowrap;
          overflow:hidden;
          text-overflow:ellipsis;
      }

      .componente-tab:hover{ filter:brightness(1.05); }
      .componente-tab.is-active{ background:#2f4256; }

      .componentes-content{ margin-top:0.25rem; }
      .componente-section{ display:none; }
      .componente-section.is-visible{ display:block; }

      .subtabs{
          display:flex;
          gap:0.6rem;
          flex-wrap:nowrap;
          overflow-x:auto;
          padding:0.15rem 0.2rem 0.6rem;
          margin:0 0 0.75rem;
      }

      .subtab{
          border:none;
          cursor:pointer;
          padding:0.55rem 1.05rem;
          border-radius:8px;
          background:#c9c9c9;
          color:#ffffff;
          font-weight:700;
          letter-spacing:0.03em;
          white-space:nowrap;
          flex:0 0 auto;
          text-transform:uppercase;
      }

      .subtab.is-active{ background:#2f4256; }

      .campos-group{ display:none; }
      .campos-group.is-visible{ display:block; }

      @media (max-width: 900px){
          .convocatoria-layout{ flex-direction:column; }
          .dimensiones-column{
              flex:none;
              max-width:none;
              width:100%;
              min-height:auto;
          }
      }
  </style>

  <!-- ‚úÖ √öNICO script para sidebar + tabs (limpio y v√°lido) -->
  <script>
      document.addEventListener("DOMContentLoaded", function () {
          // --- Collapse sidebar ---
          var column = document.querySelector(".dimensiones-column");
          var panel  = document.getElementById("dimensiones-panel");
          var toggle = document.getElementById("dimensiones-collapse-toggle");

          if (column && panel && toggle) {
              toggle.addEventListener("click", function () {
                  var collapsed = column.classList.toggle("is-collapsed");
                  panel.classList.toggle("is-hidden", collapsed);
                  toggle.setAttribute("aria-expanded", String(!collapsed));
                  toggle.textContent = collapsed ? "¬ª" : "¬´";
              });
          }

          // --- Helpers ---
          var links = Array.prototype.slice.call(document.querySelectorAll('[data-dimension-link="true"]'));
          var sections = Array.prototype.slice.call(document.querySelectorAll(".dimension-section"));

          function setActiveLink(linkEl) {
              links.forEach(function (l) { l.classList.remove("is-active"); });
              if (linkEl) linkEl.classList.add("is-active");
          }

          function getDimIdFromElement(dimEl) {
              return (dimEl && dimEl.id) ? dimEl.id.replace("dimension-", "") : null;
          }

          function storageKeyForComponent(dimId) {
              return "active_component_for_" + dimId;
          }

          function patchPaginationLinks() {
              var hash = window.location.hash;
              if (!hash) return;
              document.querySelectorAll(".pagination a[href]").forEach(function (a) {
                  a.href = a.href.split("#")[0] + hash;
              });
          }

          // --- Tabs de modo (info/auto) ---
          function getCurrentMode(root) {
              var active = root.querySelector('[data-campos-tab="true"].is-active');
              return active ? active.getAttribute("data-mode") : "info";
          }

          function setModeButtons(root, mode) {
              var btns = Array.prototype.slice.call(root.querySelectorAll('[data-campos-tab="true"]'));
              btns.forEach(function (b) {
                  b.classList.toggle("is-active", b.getAttribute("data-mode") === mode);
              });
          }

          function applyModeToComponent(compEl, mode) {
              var groups = Array.prototype.slice.call(compEl.querySelectorAll("[data-campos-group]"));
              groups.forEach(function (g) {
                  g.classList.toggle("is-visible", g.getAttribute("data-campos-group") === mode);
              });
          }

          function bindModeTabs(root) {
              var btns = Array.prototype.slice.call(root.querySelectorAll('[data-campos-tab="true"]'));
              if (!btns.length) return;

              btns.forEach(function (b) {
                  if (b.__boundClick) return;
                  b.addEventListener("click", function () {
                      var mode = b.getAttribute("data-mode") || "info";
                      setModeButtons(root, mode);

                      var visibleComp = root.querySelector(".componente-section.is-visible");
                      if (visibleComp) applyModeToComponent(visibleComp, mode);
                  });
                  b.__boundClick = true;
              });

              var mode = getCurrentMode(root);
              setModeButtons(root, mode);
              var visibleComp = root.querySelector(".componente-section.is-visible");
              if (visibleComp) applyModeToComponent(visibleComp, mode);
          }

          // --- Tabs de componentes (con sessionStorage por dimensi√≥n) ---
          function activateComponentTab(root, tabEl) {
              var tabs = Array.prototype.slice.call(root.querySelectorAll('[data-componente-tab="true"]'));
              var blocks = Array.prototype.slice.call(root.querySelectorAll(".componente-section"));

              tabs.forEach(function (t) { t.classList.remove("is-active"); });
              tabEl.classList.add("is-active");

              var targetId = tabEl.getAttribute("data-target");
              blocks.forEach(function (b) {
                  b.classList.toggle("is-visible", b.id === targetId);
              });

              // aplicar modo actual al componente visible
              var visibleComp = root.querySelector(".componente-section.is-visible");
              if (visibleComp) applyModeToComponent(visibleComp, getCurrentMode(root));

              // guardar componente activo por dimensi√≥n
              var dimId = getDimIdFromElement(root);
              if (dimId && targetId) {
                  sessionStorage.setItem(storageKeyForComponent(dimId), targetId);
              }
          }

          function bindComponentTabs(root) {
              var tabs = Array.prototype.slice.call(root.querySelectorAll('[data-componente-tab="true"]'));
              if (!tabs.length) return;

              tabs.forEach(function (t) {
                  if (t.__boundClick) return;
                  t.addEventListener("click", function () { activateComponentTab(root, t); });
                  t.__boundClick = true;
              });

              // restaurar o activar el primero
              var dimId = getDimIdFromElement(root);
              var savedTarget = dimId ? sessionStorage.getItem(storageKeyForComponent(dimId)) : null;
              var savedTab = savedTarget ? root.querySelector('[data-componente-tab="true"][data-target="' + savedTarget + '"]') : null;

              var initial = savedTab || root.querySelector(".componente-tab.is-active") || tabs[0];
              if (initial) activateComponentTab(root, initial);
          }

          function bindDimensionUI(dimEl) {
              if (!dimEl) return;
              bindModeTabs(dimEl);
              bindComponentTabs(dimEl);
          }

          function showOnlySectionById(idWithoutHash) {
              if (!idWithoutHash) return;

              sections.forEach(function (s) {
                  s.classList.toggle("is-visible", s.id === idWithoutHash);
              });

              var visibleDim = document.getElementById(idWithoutHash);
              if (visibleDim) bindDimensionUI(visibleDim);

              var newHash = "#" + idWithoutHash;
              if (history && history.replaceState) history.replaceState(null, "", newHash);
              else window.location.hash = newHash;

              patchPaginationLinks();
          }

          // --- Click en sidebar (dimensiones) ---
          links.forEach(function (link) {
              link.addEventListener("click", function (e) {
                  e.preventDefault();
                  var targetId = link.getAttribute("data-target") || (link.getAttribute("href") || "").replace("#", "");
                  if (!targetId) return;
                  setActiveLink(link);
                  showOnlySectionById(targetId);
              });
          });

          // --- On load ---
          if (window.location.hash) {
              var id = window.location.hash.replace("#", "");
              var active = document.querySelector('[data-dimension-link="true"][data-target="' + id + '"]');
              if (active) setActiveLink(active);
              showOnlySectionById(id);
          } else {
              var first = document.querySelector(".dimension-section.is-visible") || sections[0];
              if (first) {
                  var firstLink = document.querySelector('[data-dimension-link="true"][data-target="' + first.id + '"]');
                  if (firstLink) setActiveLink(firstLink);
                  showOnlySectionById(first.id);
              }
          }

          patchPaginationLinks();
      });
  </script>

  <!-- ‚úÖ Tu JS ‚Äúextra‚Äù separado para que si algo falla NO rompa el sidebar -->
  <script>
      // Modal docente
      window.openDocenteDialog = function (id) {
          if (!window.$ || !$('#' + id).length) return;
          $('#' + id).dialog({
              modal: true,
              width: '70%',
              draggable: true,
              resizable: false,
              closeText: 'Cerrar'
          });
      };

      // (Dej√° ac√° todo tu JS adicional: fetch, validaciones, stepper, etc.)
      // Te recomiendo NO mezclarlo con el script del sidebar.
  </script>
<% end %>