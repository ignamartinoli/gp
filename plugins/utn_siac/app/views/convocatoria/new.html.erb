<div class="div_section">
  <h3 class="siac_title">Nueva convocatoria</h3>
  <hr>
  <div class="steps-container">

    <ul class="stepper">
      <li class="step active" data-step="1">1. Parámetros Generales</li>
      <li class="step" data-step="2">2. Oferta Académica</li>
      <li class="step" data-step="3">3. Períodos</li>
      <li class="step" data-step="4">4. Sedes</li>
      <li class="step" data-step="5">5. Dimensiones</li>
      <li class="step" data-step="6">6. Finalizar</li>
    </ul>

    <%= form_for @convocatoria, url: create_convocatoria_path,
                html: { onsubmit: 'return validarNuevaConvocatoria(event)' } do |f| %>

      <!-- PASO 1 -->
      <div class="step-content" data-step="1">
        <h3>Parámetros Generales</h3>

         <div class="field-container">
          <div class="field">
            <%= f.label :resolucion, "Resolución: " %>
            <span class="tooltip">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-info-circle-fill"
                viewBox="0 0 16 16"
              >
                <path
                  d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"
                />
              </svg>
              <span class="tooltiptext">Número de resolución (XXXXXX/XX)</span>
            </span>
            <%= f.text_field :resolucion, id: "inputResolucion", onkeyup: "validarResolucion()" %>
          </div>
          <div class="field">
            <%= f.label :nombre, "Nombre: " %>
            <span class="tooltip">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-info-circle-fill"
                viewBox="0 0 16 16"
              >
                <path
                  d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"
                />
              </svg>
              <span class="tooltiptext">Nombre asignado representativo de la convocatoria</span>
            </span>
            <%= f.text_field :nombre, id: "inputNombre" %>
          </div>
        </div>

        <div class="error-container">
          <div class="errorResolucion"></div>
          <div class="errorNombre"></div>
        </div>
       <div class="step-buttons">
          <button type="button" class="step-btn next-step">Siguiente</button>
        </div>

      </div>

      <!-- PASO 2 -->
      <div class="step-content" data-step="2" style="display:none">
        <h3>Selección de Oferta Académica</h3>
          <div class="field">
            <%= f.label :titulaciones, "Titulación: " %>
            <span class="tooltip">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-info-circle-fill"
                viewBox="0 0 16 16"
              >
                <path
                  d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"
                />
              </svg>
              <span class="tooltiptext">Tipo de Titulación a la cual referira la convocatoria</span>
            </span>
            <%= f.select :titulaciones,
                    options_for_select(@titulaciones),
                    include_blank: "Selecciona una opción",
                    onchange: "actualizarEspecialidades(this.value)" %>
          </div>
          <div class="error-container">
            <div class="errorTitulacion"></div>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between">
            <label>Selecciona las especialidades:</label>
            <input
              type="text"
              id="searchEspecialidades"
              class="search-input"
              placeholder="Filtrar por código o nombre…"
              oninput="filterEspecialidades()"
              autocomplete="off"
              style="margin-right: 20px"
            >
          </div>

          <div class="table-wrapper">
            <table class="table custom-table" id="tableEspecialidades">
              <thead>
                <tr>
                  <th scope="col">
                    <div class="checkboxConvContainer">
                      <input type="checkbox" class="checkbox" id="checkBoxConv">
                      Seleccionar Todo
                    </div>
                  </th>
                  <th scope="col">Cod. Especialidad</th>
                  <th scope="col">Nombre de Especialidad</th>
                </tr>
              </thead>
              <!-- Aquí se cargarán las especialidades con JS (AJAX) -->
              <%= render partial: "especialidades", locals: { especialidades: @especialidades } %>
            </table>
          </div>

          <div class="error-container">
            <div class="errorEspecialidades"></div>
          </div>




       <div class="step-buttons">
          <button type="button" class="step-btn prev-step">Atrás</button>
          <button type="button" class="step-btn next-step">Siguiente</button>
        </div>

      </div>

      <!-- PASO 3 -->
      <div class="step-content" data-step="3" style="display:none">
        <h3>Períodos de Convocatoria</h3>

        <div class="field-container">
          <div class="field">
            <label>Fecha de la convocatoria:</label>
          </div>
          <span class="tooltip">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="bi bi-info-circle-fill"
              viewBox="0 0 16 16"
            >
              <path
                d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"
              />
            </svg>
            <span class="tooltiptext">Fecha desde y hasta estará abierta la convocatoria</span>
          </span>
          <div class="field">
            <%= f.label :fecha_inicio, "Desde: " %>
            <%= f.date_field :fecha_inicio, data: { required: true } %>
          </div>
          <div class="field">
            <%= f.label :fecha_hasta, "Hasta:" %>
            <%= f.date_field :fecha_hasta, data: { required: true } %>
          </div>
        </div>
        <div class="error-container">
          <div></div>
          <div class="errorFechaInicio"></div>
          <div class="errorFechaHasta"></div>
        </div>

       <div class="step-buttons">
          <button type="button" class="step-btn prev-step">Atrás</button>
          <button type="button" class="step-btn next-step">Siguiente</button>
        </div>

      </div>

      <!-- PASO 4 -->
      <div class="step-content" data-step="4" style="display:none">
        <h3>Sedes</h3>

        <div class="table-wrapper">
          <table class="custom-table scroll-table" id="tableSedes">
            <thead>
              <tr>
                <th scope="col">
                  <div class="checkboxConvContainer">
                    <input type="checkbox" id="checkBoxConvSedes">
                    Seleccionar Todo
                  </div>
                </th>
                <th scope="col">FACULTAD REGIONAL</th>
                <th scope="col">EXTENSIÓN AULICA</th>
              </tr>
            </thead>
            <!-- Aquí se cargarán las sedes con JS (AJAX) -->
            <%= render partial: "sedes", locals: { sedes: @sedes } %>
          </table>
        </div>

        <div class="error-container">
          <div class="errorSedes"></div>
        </div>

       <div class="step-buttons">
          <button type="button" class="step-btn prev-step">Atrás</button>
          <button type="button" class="step-btn next-step">Siguiente</button>
        </div>

      </div>

      <!-- PASO 5 -->
      <div class="step-content" data-step="5" style="display:none">
        <h3>Dimensiones</h3>

          <div class="table-wrapper">
            <table class="custom-table scroll-table" id='tableDimensiones'>
              <thead>
                <tr>
                  <th scope="col">
                    <div class="checkboxConvContainer">
                      <input type="checkbox" id="checkBoxConvDimensiones">
                      Seleccionar Todo
                    </div>
                  </th>
                  <th scope="col">Dimensiones</th>
                  <th scope="col" class="thDesc">Componentes</th>
                </tr>
              </thead>
              <tbody id="dimensiones-container">
                <% @componentes.each do |componente| %>
                  <tr>
                    <td>
                      <div class="checkboxConvContainer">
                        <input
                          type="checkbox"
                          class="checkbox rowCheckboxesComponente"
                          name="componentes_codigos[]"
                          id="check<%= componente.id %>"
                          value="<%= componente.id %>"
                        >
                        Seleccionar
                      </div>
                    </td>
                    <td><%= get_nombre_dimension(componente.dimension_id) %></td>
                    <td><%= componente.nombre %></td>
                  </tr>
                <% end %>
                <tr class="paginationTr"><td colspan=3></td></tr>
              </tbody>
            </table>
          </div>

          <div class="error-container">
            <div class="errorDimensiones"></div>
          </div>

        <div class="step-buttons">
          <button type="button" class="step-btn prev-step">Atrás</button>
          <button type="button" class="step-btn next-step">Siguiente</button>
        </div>

      </div>




      <!-- PASO 7 -->
      <div class="step-content" data-step="6" style="display:none">
        <h3>Revisión final</h3>
        <br>
        <br>
        <br>
        <p>Verificá los datos y creá la convocatoria.</p>
        <br>
        <br>
        <button type="button" class="step-btn" onclick="generarPDF()">Generar PDF</button>
        <br>
        <br>
                  
        
          <div class="step-buttons">
            <button type="button" class="step-btn prev-step">Atrás</button>
            <button type="submit" id="inputSubmit" class="step-btn">
              Crear Convocatoria
            </button>
          </div>
          <div class="actions">
            
          </div>
      </div>
   
    <% end %>
  </div>
<% content_for :header_tags do %>
  <%= stylesheet_link_tag "siac.css", plugin: :utn_siac %>
  <%= javascript_include_tag "especialidades", plugin: :utn_siac %>
  <%= javascript_include_tag "sedes", plugin: :utn_siac %>
  <%= javascript_include_tag "validaciones_convocatorias", plugin: :utn_siac %>
  <%= javascript_include_tag "stepper_convocatorias.js", plugin: :utn_siac %>
  <%= csrf_meta_tags %>
<% end %>

<script>
// --- Accent-insensitive helper without Unicode properties ---
(function() {
  var ACCENTS_MAP = {
    'á':'a','à':'a','ä':'a','â':'a','ã':'a','å':'a','Á':'a','À':'a','Ä':'a','Â':'a','Ã':'a','Å':'a',
    'é':'e','è':'e','ë':'e','ê':'e','É':'e','È':'e','Ë':'e','Ê':'e',
    'í':'i','ì':'i','ï':'i','î':'i','Í':'i','Ì':'i','Ï':'i','Î':'i',
    'ó':'o','ò':'o','ö':'o','ô':'o','õ':'o','Ó':'o','Ò':'o','Ö':'o','Ô':'o','Õ':'o',
    'ú':'u','ù':'u','ü':'u','û':'u','Ú':'u','Ù':'u','Ü':'u','Û':'u',
    'ñ':'n','Ñ':'n','ç':'c','Ç':'c'
  };
  function stripAccents(s) {
    return (s || '').replace(/[^A-Za-z0-9\s]/g, function(ch){
      return ACCENTS_MAP[ch] || ch;
    }).toLowerCase();
  }

  function doFilterEspecialidades() {
    var input  = document.getElementById('searchEspecialidades');
    var table  = document.getElementById('tableEspecialidades');
    var tbody  = table && table.querySelector('#especialidades-container');
    if (!tbody) return;

    var term = stripAccents(input ? input.value.trim() : '');
    var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'))
      .filter(function(tr){ return !tr.classList.contains('paginationTr'); });

    var visible = 0;
    rows.forEach(function(tr){
      var tds = tr.getElementsByTagName('td');
      if (tds.length < 3) return; // [checkbox], [codigo], [nombre]
      var codigo = stripAccents(tds[1].textContent);
      var nombre = stripAccents(tds[2].textContent);
      var show   = !term || codigo.indexOf(term) !== -1 || nombre.indexOf(term) !== -1;
      tr.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    var counter = document.getElementById('searchEspecialidadesCount');
    if (counter) {
      var total = rows.length;
      counter.textContent = term
        ? (visible + ' resultado' + (visible === 1 ? '' : 's') + ' de ' + total)
        : (total + ' especialidades');
    }
  }

  // Expose a hook we can call after AJAX reloads
  window.applyEspecialidadesFilter = function() {
    // Re-bind the input handler (in case the input was re-rendered)
    var input = document.getElementById('searchEspecialidades');
    if (input && !input.dataset._bound) {
      input.addEventListener('input', doFilterEspecialidades);
      input.dataset._bound = '1';
    }
    // Apply immediately
    doFilterEspecialidades();
  };

  // Initial bind on DOM ready
  document.addEventListener('DOMContentLoaded', window.applyEspecialidadesFilter);
})();


  function generarPDF() {
      const form = document.getElementById("new_convocatoria");
      const data = new FormData(form);

      // checkboxes dinámicos
      document.querySelectorAll("input[name='componentes_codigos[]']").forEach(ch => {
          if (ch.checked) data.append("componentes_codigos[]", ch.value);
      });

      document.querySelectorAll("input[name='sedes_codigos[]']").forEach(ch => {
          if (ch.checked) data.append("sedes_codigos[]", ch.value);
      });

      document.querySelectorAll("input[name='especialidad_ids[]']").forEach(ch => {
          if (ch.checked) data.append("especialidad_ids[]", ch.value);
      });

      // campos texto/select
      data.append("resolucion", document.getElementById("inputResolucion").value);
      data.append("nombre", document.getElementById("inputNombre").value);
      data.append("titulaciones", document.getElementById("convocatoria_titulaciones").value);
      data.append("fecha_inicio", document.getElementById("convocatoria_fecha_inicio").value);
      data.append("fecha_hasta", document.getElementById("convocatoria_fecha_hasta").value);

      // CSRF
      const token = document.querySelector('meta[name="csrf-token"]').getAttribute("content");

      fetch("/convocatorias/pdf_preview", {
          method: "POST",
          headers: { "X-CSRF-Token": token },
          body: data
      })
      .then(response => {
          if (!response.ok) throw new Error("Error en la generación del PDF");
          return response.blob();
      })
      .then(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "Vista_Prevista_Convocatoria.pdf";
          a.click();
      })
      .catch(err => console.error("Error generando PDF:", err));
  }



</script>
